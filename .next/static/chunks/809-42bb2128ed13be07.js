"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[809],{1827:function(e,t,r){r.r(t),r.d(t,{getFirebase:function(){return c}});var a=r(738),n=r(5978),i=r(3301);let o=null,s=null,l=null;function c(){let e="AIzaSyDYTudeKDSvY_IrwI5nookV0cv828uAAvU";return e?(o||(o=(0,a.ZF)({apiKey:e,authDomain:"redemptionprojectversion.firebaseapp.com",projectId:"redemptionprojectversion",storageBucket:"redemptionprojectversion.firebasestorage.app",messagingSenderId:"262491376013",appId:"1:262491376013:web:edc2194e6bb7819294d5c4"}),s=(0,n.ad)(o),l=(0,i.v0)(o)),{app:o,db:s,auth:l}):{app:null,db:null,auth:null}}},4768:function(e,t,r){r.r(t),r.d(t,{FirestoreRepository:function(){return i}});var a=r(5978),n=r(1827);class i{getDb(){let{db:e}=(0,n.getFirebase)();if(!e)throw Error("Firebase not initialized. Please check your Firebase configuration.");return e}async getTranslation(e){var t,r;let n=this.getDb(),i=(0,a.JU)(n,"translations",e),o=await (0,a.QT)(i);if(!o.exists())return null;let s=o.data();return{...s,createdAt:null===(t=s.createdAt)||void 0===t?void 0:t.toDate(),updatedAt:null===(r=s.updatedAt)||void 0===r?void 0:r.toDate()}}async saveTranslation(e){let t=this.getDb(),r=(0,a.JU)(t,"translations",e.id),n=a.EK.now(),i={...e,createdAt:e.createdAt?a.EK.fromDate(e.createdAt):n,updatedAt:n};await (0,a.pl)(r,i,{merge:!0})}async getAllTranslations(){let e=this.getDb(),t=(0,a.IO)((0,a.hJ)(e,"translations"));return(await (0,a.PL)(t)).docs.map(e=>{var t,r;let a=e.data();return{...a,createdAt:null===(t=a.createdAt)||void 0===t?void 0:t.toDate(),updatedAt:null===(r=a.updatedAt)||void 0===r?void 0:r.toDate()}})}subscribeToTranslation(e,t){let r=this.getDb(),n=(0,a.JU)(r,"translations",e);return(0,a.cf)(n,e=>{var r,a;if(!e.exists()){t(null);return}let n=e.data();t({...n,createdAt:null===(r=n.createdAt)||void 0===r?void 0:r.toDate(),updatedAt:null===(a=n.updatedAt)||void 0===a?void 0:a.toDate()})})}subscribeToAllTranslations(e){let t=this.getDb(),r=(0,a.IO)((0,a.hJ)(t,"translations"));return(0,a.cf)(r,t=>{e(t.docs.map(e=>{var t,r;let a=e.data();return{...a,createdAt:null===(t=a.createdAt)||void 0===t?void 0:t.toDate(),updatedAt:null===(r=a.updatedAt)||void 0===r?void 0:r.toDate()}}))})}async getProjectionChannel(e){var t;let r=this.getDb(),n=(0,a.JU)(r,"channels",e),i=await (0,a.QT)(n);if(!i.exists())return null;let o=i.data();return{...o,timestamp:null===(t=o.timestamp)||void 0===t?void 0:t.toDate()}}async saveProjectionChannel(e,t){let r=this.getDb(),n=(0,a.JU)(r,"channels",e),i={...t,timestamp:t.timestamp?a.EK.fromDate(t.timestamp):a.EK.now()};await (0,a.pl)(n,i,{merge:!0})}subscribeToProjectionChannel(e,t){let r=this.getDb(),n=(0,a.JU)(r,"channels",e);return(0,a.cf)(n,e=>{var r;if(!e.exists()){t(null);return}let a=e.data();t({...a,timestamp:null===(r=a.timestamp)||void 0===r?void 0:r.toDate()})})}}},7809:function(e,t,r){r.d(t,{R:function(){return p}});var a=r(9625),n=r(960);let i=null;function o(){return i||(i=(0,n.X3)("rpv-bible-cache",1,{upgrade(e){e.objectStoreNames.contains("translations")||e.createObjectStore("translations",{keyPath:"id"}).createIndex("by-id","id",{unique:!0}),e.objectStoreNames.contains("projectionChannels")||e.createObjectStore("projectionChannels",{keyPath:"channelId"}).createIndex("by-channel","channelId",{unique:!0})}})),i}class s{async saveTranslation(e){try{let t=await o();await t.put("translations",e)}catch(e){console.error("Error saving translation to IndexedDB:",e)}}async getTranslation(e){try{let t=await o();return await t.get("translations",e)||null}catch(e){return console.error("Error getting translation from IndexedDB:",e),null}}async getAllTranslations(){try{let e=await o();return await e.getAll("translations")}catch(e){return console.error("Error getting all translations from IndexedDB:",e),[]}}async deleteTranslation(e){try{let t=await o();await t.delete("translations",e)}catch(e){console.error("Error deleting translation from IndexedDB:",e)}}async saveProjectionChannel(e,t){try{let r=await o();await r.put("projectionChannels",{channelId:e,ref:t,timestamp:Date.now()})}catch(e){console.error("Error saving projection channel to IndexedDB:",e)}}async getProjectionChannel(e){try{let t=await o(),r=await t.get("projectionChannels",e);return(null==r?void 0:r.ref)||null}catch(e){return console.error("Error getting projection channel from IndexedDB:",e),null}}async clearCache(){try{let e=await o();await e.clear("translations"),await e.clear("projectionChannels")}catch(e){console.error("Error clearing IndexedDB cache:",e)}}async isAvailable(){try{return await o(),!0}catch(e){return!1}}}var l=r(4768);let c="rpv-offline-queue";class d{async getPendingOperations(){try{let e=localStorage.getItem(c);if(!e)return[];return JSON.parse(e).filter(e=>e.retries<3)}catch(e){return console.error("Error reading offline queue:",e),[]}}async addOperation(e){try{let t=await this.getPendingOperations(),r={...e,id:"".concat(e.type,"-").concat(Date.now(),"-").concat(Math.random()),timestamp:Date.now(),retries:0};t.push(r),localStorage.setItem(c,JSON.stringify(t))}catch(e){console.error("Error adding to offline queue:",e)}}async removeOperation(e){try{let t=(await this.getPendingOperations()).filter(t=>t.id!==e);localStorage.setItem(c,JSON.stringify(t))}catch(e){console.error("Error removing from offline queue:",e)}}async incrementRetry(e){try{let t=(await this.getPendingOperations()).map(t=>t.id===e?{...t,retries:t.retries+1}:t);localStorage.setItem(c,JSON.stringify(t))}catch(e){console.error("Error incrementing retry:",e)}}async clearQueue(){try{localStorage.removeItem(c)}catch(e){console.error("Error clearing offline queue:",e)}}async processQueue(e){for(let t of(await this.getPendingOperations()))try{let r=e[t.type];if(!r){await this.removeOperation(t.id);continue}await r(t.data),await this.removeOperation(t.id)}catch(e){console.error("Error processing ".concat(t.type,":"),e),await this.incrementRetry(t.id)}}}var u=r(8535);class h{async getTranslation(e){if(this.memoryCache.has(e))return this.memoryCache.get(e);try{let t=await this.indexedDB.getTranslation(e);if(t)return this.memoryCache.set(e,t),t}catch(e){console.warn("IndexedDB cache read failed, trying Firestore:",e)}try{let{db:t}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase());if(t){let t=await this.repository.getTranslation(e);return t&&(this.memoryCache.set(e,t),await this.indexedDB.saveTranslation(t).catch(()=>{})),t}}catch(e){console.warn("Firestore read failed:",e)}return null}async getAllTranslations(){try{let e=await this.indexedDB.getAllTranslations();if(e.length>0)return e.forEach(e=>this.memoryCache.set(e.id,e)),this.refreshFromFirestore().catch(()=>{}),e}catch(e){console.warn("IndexedDB read failed, trying Firestore:",e)}try{let{db:e}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase());if(e){let e=await this.repository.getAllTranslations();return e.forEach(e=>{this.memoryCache.set(e.id,e),this.indexedDB.saveTranslation(e).catch(()=>{})}),e}}catch(e){console.warn("Firestore read failed:",e)}return[]}async saveTranslation(e){this.memoryCache.set(e.id,e),await this.indexedDB.saveTranslation(e).catch(()=>{});let t=u.I.getOnline();try{let{db:a,auth:n}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase()),i=!!n&&!!n.currentUser;a&&t&&i?await this.repository.saveTranslation(e):t||await this.offlineQueue.addOperation({type:"saveTranslation",data:e})}catch(r){var a;let t=String((null==r?void 0:null===(a=r.toString)||void 0===a?void 0:a.call(r))||r);t.includes("Missing or insufficient permissions")||t.includes("permission-denied")||await this.offlineQueue.addOperation({type:"saveTranslation",data:e})}}async mergeTranslation(e){let t;let a=await this.getTranslation(e.id);t=a?this.mergeTranslations(a,e):e,this.memoryCache.set(t.id,t),await this.indexedDB.saveTranslation(t).catch(()=>{});let n=u.I.getOnline();try{let{db:e,auth:a}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase()),i=!!a&&!!a.currentUser;e&&n&&i?await this.repository.saveTranslation(t):n||await this.offlineQueue.addOperation({type:"mergeTranslation",data:t})}catch(r){var i;let e=String((null==r?void 0:null===(i=r.toString)||void 0===i?void 0:i.call(r))||r);e.includes("Missing or insufficient permissions")||e.includes("permission-denied")||await this.offlineQueue.addOperation({type:"mergeTranslation",data:t})}return t}async getProjectionChannel(e){try{let t=await this.indexedDB.getProjectionChannel(e);if(t)return t}catch(e){console.warn("IndexedDB read failed:",e)}try{let{db:t}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase());if(t){let t=await this.repository.getProjectionChannel(e);return t&&await this.indexedDB.saveProjectionChannel(e,t).catch(()=>{}),t}}catch(e){console.warn("Firestore read failed:",e)}return null}async saveProjectionChannel(e,t){await this.indexedDB.saveProjectionChannel(e,t).catch(()=>{});let a=u.I.getOnline();try{let{db:n}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase());n&&a?await this.repository.saveProjectionChannel(e,t):a||await this.offlineQueue.addOperation({type:"sendToProjector",data:{channelId:e,ref:t}})}catch(r){console.warn("Firestore save failed, queuing for later:",r),await this.offlineQueue.addOperation({type:"sendToProjector",data:{channelId:e,ref:t}})}}async refreshFromFirestore(){try{let{db:e}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase());if(!e)return;(await this.repository.getAllTranslations()).forEach(e=>{this.memoryCache.set(e.id,e),this.indexedDB.saveTranslation(e).catch(()=>{})})}catch(e){}}mergeTranslations(e,t){let r;let a=e.books.find(e=>{var r;return e.name===(null===(r=t.books[0])||void 0===r?void 0:r.name)});if(a){let n=t.books[0],i=[...a.chapters];n.chapters.forEach(e=>{let t=i.findIndex(t=>t.number===e.number);if(t>=0){let r=i[t],a=[...r.verses];e.verses.forEach(e=>{let t=a.findIndex(t=>t.number===e.number);t>=0?a[t]=e:a.push(e)}),a.sort((e,t)=>e.number-t.number),i[t]={...r,verses:a}}else i.push(e)}),i.sort((e,t)=>e.number-t.number),r=e.books.map(e=>e.name===a.name?{...e,chapters:i}:e)}else r=[...e.books,t.books[0]];return{...e,name:t.name||e.name,books:r,updatedAt:new Date}}clearMemoryCache(){this.memoryCache.clear()}async clearAllCaches(){this.memoryCache.clear(),await this.indexedDB.clearCache(),await this.offlineQueue.clearQueue()}async processPendingOperations(){try{let{auth:e}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase());if(!(e&&e.currentUser))return}catch(e){return}await this.offlineQueue.processQueue({saveTranslation:async e=>{let{db:t}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase());t&&await this.repository.saveTranslation(e)},mergeTranslation:async e=>{await this.mergeTranslation(e)},sendToProjector:async e=>{let{db:t}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase());t&&await this.repository.saveProjectionChannel(e.channelId,e.ref)}})}constructor(){this.memoryCache=new Map,this.indexedDB=new s,this.repository=new l.FirestoreRepository,this.offlineQueue=new d,u.I.subscribe(async e=>{e&&await this.processPendingOperations()})}}class g{async getTranslation(e){try{return await this.cacheManager.getTranslation(e)}catch(e){throw console.error("Error getting translation:",e),e}}async getAllTranslations(){try{return await this.cacheManager.getAllTranslations()}catch(e){throw console.error("Error getting all translations:",e),e}}async saveTranslation(e){try{let t=new Date,r={...e,createdAt:e.createdAt||t,updatedAt:t};await this.cacheManager.saveTranslation(r)}catch(e){throw console.error("Error saving translation:",e),e}}async mergeTranslation(e){try{return await this.cacheManager.mergeTranslation(e)}catch(e){throw console.error("Error merging translation:",e),e}}async addOrUpdateVerse(e,t,r,a,n){try{let i=await this.getTranslation(e);if(!i){await this.saveTranslation({id:e,name:e,books:[{name:t,chapters:[{number:r,verses:[{number:a,text:n}]}]}]});return}let o=this.addVerseToTranslation(i,t,r,a,n);await this.saveTranslation(o)}catch(e){throw console.error("Error adding/updating verse:",e),e}}addVerseToTranslation(e,t,r,a,n){let i=e.books.find(e=>e.name===t);if(i){let e=i.chapters.find(e=>e.number===r);if(e){let t=e.verses.find(e=>e.number===a);t?t.text=n:(e.verses.push({number:a,text:n}),e.verses.sort((e,t)=>e.number-t.number))}else i.chapters.push({number:r,verses:[{number:a,text:n}]}),i.chapters.sort((e,t)=>e.number-t.number)}else e.books.push({name:t,chapters:[{number:r,verses:[{number:a,text:n}]}]});return{...e,updatedAt:new Date}}subscribeToTranslation(e,t){let{FirestoreRepository:a}=r(4768);return new a().subscribeToTranslation(e,t)}subscribeToAllTranslations(e){let{FirestoreRepository:t}=r(4768);return new t().subscribeToAllTranslations(e)}constructor(){this.cacheManager=new h}}class v{async sendToProjector(e,t){try{let{current:r}=p.getState();if(!r)return;let a=r.books.find(e=>e.name===t.book),n=null==a?void 0:a.chapters.find(e=>e.number===t.chapter),i=null==n?void 0:n.verses.find(e=>e.number===t.verse),o={translation:r.name,book:t.book,chapter:t.chapter,verse:t.verse,text:(null==i?void 0:i.text)||"",timestamp:new Date};await this.cacheManager.saveProjectionChannel(e,o)}catch(e){throw console.error("Error sending to projector:",e),e}}subscribeToChannel(e,t){let{FirestoreRepository:a}=r(4768);return new a().subscribeToProjectionChannel(e,r=>{r&&this.cacheManager.saveProjectionChannel(e,r).catch(()=>{}),t(r)})}async getChannel(e){try{return await this.cacheManager.getProjectionChannel(e)}catch(e){throw console.error("Error getting channel:",e),e}}constructor(){this.cacheManager=new h}}let m={id:"sample",name:"Sample Translation",books:[{name:"John",chapters:[{number:3,verses:[{number:16,text:"For God so loved the world, that he gave his only Son, that whoever believes in him should not perish but have eternal life."}]}]}]},p=(0,a.Ue)((e,t)=>{let a=new g,n=new v;return{translations:[],current:null,projectorRef:{translation:"",book:"",chapter:0,verse:0,text:""},channelId:"default",isLoading:!1,error:null,_translationService:a,_projectionService:n,_unsubscribers:{},loadTranslations:async()=>{e({isLoading:!0,error:null});try{var n,i,o,s;let l=await a.getAllTranslations();if(0===l.length){try{let t=[];for(let e of[{url:"/translations/kjv.json"},{url:"/translations/asv.json"}])try{let r=await fetch(e.url,{cache:"no-store"});if(r.ok){let e=await r.json(),i=null!==(n=null==e?void 0:e.translations)&&void 0!==n?n:[];if(Array.isArray(i)&&i.length>0)for(let e of i)await a.saveTranslation(e),t.push(e)}}catch(e){}if(t.length>0){e({translations:t,current:t[0],isLoading:!1});return}}catch(e){}t().loadSample(),e({isLoading:!1});return}try{let t=new Set(l.map(e=>e.id)),r=["kjv","asv"].filter(e=>!t.has(e)),n=[];if(r.length>0)for(let e of r){let t=await fetch("/translations/".concat(e,".json"),{cache:"no-store"});if(t.ok){let e=await t.json();for(let t of null!==(i=null==e?void 0:e.translations)&&void 0!==i?i:[])await a.saveTranslation(t),n.push(t)}}let s=n.length>0?[...l,...n]:l;e({translations:s,current:null!==(o=s[0])&&void 0!==o?o:null,isLoading:!1})}catch(t){e({translations:l,current:null!==(s=l[0])&&void 0!==s?s:null,isLoading:!1})}try{let{db:n}=await Promise.resolve().then(r.bind(r,1827)).then(e=>e.getFirebase());if(n){let r=a.subscribeToAllTranslations(r=>{var a,n;e({translations:r,current:null!==(n=null!==(a=t().current)&&void 0!==a?a:r[0])&&void 0!==n?n:null})}),n=t()._unsubscribers;n.translations&&n.translations(),n.translations=r}}catch(e){console.warn("Firestore subscription failed, using cached data:",e)}}catch(r){console.error("Error loading translations:",r),e({error:r instanceof Error?r.message:"Failed to load translations",isLoading:!1}),t().loadSample()}},loadSample:()=>{0===t().translations.length&&e({translations:[m],current:m})},setCurrent:r=>{var a;e({current:null!==(a=t().translations.find(e=>e.id===r))&&void 0!==a?a:null})},setReference:e=>{},setChannelId:r=>{e({channelId:r}),t().subscribeToChannel()},sendToProjector:async e=>{try{let{current:r,channelId:a}=t();if(!r)return;await n.sendToProjector(a||"default",e)}catch(i){console.error("Error sending to projector:",i);let{current:a,channelId:n}=t();if(a){var r;let t=a.books.find(t=>t.name===e.book),i=null==t?void 0:t.chapters.find(t=>t.number===e.chapter),o=null==i?void 0:i.verses.find(t=>t.number===e.verse),s={translation:a.name,book:e.book,chapter:e.chapter,verse:e.verse,text:null!==(r=null==o?void 0:o.text)&&void 0!==r?r:""};localStorage.setItem("rpv:projector:".concat(n||"default"),JSON.stringify(s)),window.dispatchEvent(new StorageEvent("storage",{key:"rpv:projector:".concat(n||"default")}))}}},subscribeToChannel:()=>{let{channelId:a,_projectionService:n}=t(),i=a||"default",o=t()._unsubscribers;o.channel&&o.channel();let{getFirebase:s}=r(1827),{db:l}=s();if(l)try{let t=n.subscribeToChannel(i,t=>{t&&e({projectorRef:t})});o.channel=t;return}catch(e){console.error("Error subscribing to Firestore channel:",e)}let c=()=>{try{let t=localStorage.getItem("rpv:projector:".concat(i));t&&e({projectorRef:JSON.parse(t)})}catch(e){}};c();let d=e=>{e.key==="rpv:projector:".concat(i)&&c()};window.addEventListener("storage",d),o.channel=()=>{window.removeEventListener("storage",d)}},importJson:async r=>{var a,n,i,o;try{let i=null!==(a=r.translations)&&void 0!==a?a:[],{_translationService:o}=t();for(let e of i)await o.saveTranslation(e);e({translations:i,current:null!==(n=i[0])&&void 0!==n?n:null})}catch(a){console.error("Error importing JSON:",a);let t=null!==(i=r.translations)&&void 0!==i?i:[];e({translations:t,current:null!==(o=t[0])&&void 0!==o?o:null})}},mergeTranslation:async r=>{try{var a,n;let{_translationService:i}=t(),o=await i.mergeTranslation(r),s=t(),l=s.translations.findIndex(e=>e.id===r.id);if(l>=0){let t=[...s.translations];t[l]=o,e({translations:t,current:(null===(a=s.current)||void 0===a?void 0:a.id)===r.id?o:s.current})}else e({translations:[...s.translations,o],current:null!==(n=s.current)&&void 0!==n?n:o})}catch(e){throw console.error("Error merging translation:",e),e}},addOrUpdateVerse:async e=>{let{translationId:r,book:a,chapter:n,verse:i,text:o}=e;try{let{_translationService:e}=t();await e.addOrUpdateVerse(r,a,n,i,o),await t().loadTranslations()}catch(e){throw console.error("Error adding/updating verse:",e),e}}}})},8535:function(e,t,r){r.d(t,{I:function(){return a}});class a{static init(){a.isOnline=navigator.onLine,window.addEventListener("online",()=>{a.isOnline=!0,a.notifyListeners(!0)}),window.addEventListener("offline",()=>{a.isOnline=!1,a.notifyListeners(!1)})}static getOnline(){return a.isOnline}static subscribe(e){return a.listeners.add(e),e(a.isOnline),()=>{a.listeners.delete(e)}}static notifyListeners(e){a.listeners.forEach(t=>t(e))}}a.isOnline=navigator.onLine,a.listeners=new Set,a.init()}}]);